<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phrasey Chain Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-form h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            color: white;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .puzzle-form-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }

        .date-difficulty-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .clues-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e8ebff;
        }

        .clue-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .clue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .clue-number {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }

        .clue-textarea {
            height: 60px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .answer-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .puzzle-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .puzzle-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #f8f9ff;
        }

        .puzzle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .puzzle-date {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2rem;
        }

        .puzzle-actions {
            display: flex;
            gap: 5px;
        }

        .clues-preview {
            display: grid;
            gap: 8px;
        }

        .clue-preview-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .clue-preview-text {
            font-style: italic;
            margin-bottom: 5px;
            color: #666;
        }

        .clue-preview-answer {
            font-weight: bold;
            color: #333;
            font-size: 0.9rem;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        .validation-error {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .connection-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .puzzle-form-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-container {
                padding: 10px;
            }
            
            .header-top {
                flex-direction: column;
                gap: 10px;
            }

            .answer-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connection-offline">
        Checking connection...
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-form">
            <h1>üéÆ Admin Login</h1>
            <div id="loginError" class="error-message" style="display: none;"></div>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" placeholder="Username" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Password" required>
            </div>
            <button class="btn" onclick="login()" style="width: 100%;">Login</button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-container" style="display: none;">
        <div class="header">
            <div class="header-top">
                <h1 class="title">üéÆ Phrasey Chain Admin</h1>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPuzzles">-</div>
                    <div class="stat-label">Daily Puzzles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="futurePuzzles">-</div>
                    <div class="stat-label">Future Puzzles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayPuzzle">-</div>
                    <div class="stat-label">Today's Puzzle</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayPlays">-</div>
                    <div class="stat-label">Today's Plays</div>
                </div>
            </div>
        </div>

        <!-- Create Puzzle Panel -->
        <div class="panel">
            <h2>‚ûï Create/Edit Daily Puzzle (5 Clues)</h2>
            <div id="puzzleFormError" class="error-message" style="display: none;"></div>
            <div id="puzzleFormSuccess" class="success-message" style="display: none;"></div>
            
            <form id="puzzleForm">
                <input type="hidden" id="editingPuzzleId" value="">
                
                <div class="puzzle-form-grid">
                    <div class="date-difficulty-section">
                        <div class="form-group">
                            <label for="puzzleDate">üìÖ Date:</label>
                            <input type="date" id="puzzleDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="puzzleDifficulty">‚≠ê Difficulty (1-5):</label>
                            <input type="number" id="puzzleDifficulty" min="1" max="5" value="1">
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn" id="submitBtn">Create Daily Puzzle</button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear All</button>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-secondary" onclick="generateSamplePuzzle()">Generate Sample</button>
                            <button type="button" class="btn btn-secondary" onclick="validateAllClues()">Validate All</button>
                        </div>

                        <div class="form-group" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <label for="copyFromDate">üìã Copy from existing puzzle:</label>
                            <input type="date" id="copyFromDate" style="margin-bottom: 8px;">
                            <button type="button" class="btn btn-secondary" onclick="copyFromDate()" style="width: 100%;">Copy Clues</button>
                            <div id="copyStatus" style="font-size: 0.85rem; color: #666; margin-top: 5px;"></div>
                        </div>
                    </div>

                    <div class="clues-section">
                        <h3 style="margin-bottom: 15px; color: #667eea;">5 Daily Clues</h3>
                        
                        <div class="clue-item">
                            <div class="clue-header">
                                <span class="clue-number">Clue 1</span>
                            </div>
                            <textarea class="clue-textarea" id="clue1" placeholder="e.g., Device for pointing and clicking + Device to catch rodents" required></textarea>
                            <div class="answer-row">
                                <input type="text" id="answer1" placeholder="e.g., COMPUTER MOUSE TRAP" required style="text-transform: uppercase;">
                                <input type="text" id="linking1" placeholder="MOUSE" required style="text-transform: uppercase;">
                            </div>
                            <div id="validation1" class="validation-error"></div>
                        </div>

                        <div class="clue-item">
                            <div class="clue-header">
                                <span class="clue-number">Clue 2</span>
                            </div>
                            <textarea class="clue-textarea" id="clue2" placeholder="Second clue..." required></textarea>
                            <div class="answer-row">
                                <input type="text" id="answer2" placeholder="SECOND ANSWER" required style="text-transform: uppercase;">
                                <input type="text" id="linking2" placeholder="LINK" required style="text-transform: uppercase;">
                            </div>
                            <div id="validation2" class="validation-error"></div>
                        </div>

                        <div class="clue-item">
                            <div class="clue-header">
                                <span class="clue-number">Clue 3</span>
                            </div>
                            <textarea class="clue-textarea" id="clue3" placeholder="Third clue..." required></textarea>
                            <div class="answer-row">
                                <input type="text" id="answer3" placeholder="THIRD ANSWER" required style="text-transform: uppercase;">
                                <input type="text" id="linking3" placeholder="LINK" required style="text-transform: uppercase;">
                            </div>
                            <div id="validation3" class="validation-error"></div>
                        </div>

                        <div class="clue-item">
                            <div class="clue-header">
                                <span class="clue-number">Clue 4</span>
                            </div>
                            <textarea class="clue-textarea" id="clue4" placeholder="Fourth clue..." required></textarea>
                            <div class="answer-row">
                                <input type="text" id="answer4" placeholder="FOURTH ANSWER" required style="text-transform: uppercase;">
                                <input type="text" id="linking4" placeholder="LINK" required style="text-transform: uppercase;">
                            </div>
                            <div id="validation4" class="validation-error"></div>
                        </div>

                        <div class="clue-item">
                            <div class="clue-header">
                                <span class="clue-number">Clue 5</span>
                            </div>
                            <textarea class="clue-textarea" id="clue5" placeholder="Fifth clue..." required></textarea>
                            <div class="answer-row">
                                <input type="text" id="answer5" placeholder="FIFTH ANSWER" required style="text-transform: uppercase;">
                                <input type="text" id="linking5" placeholder="LINK" required style="text-transform: uppercase;">
                            </div>
                            <div id="validation5" class="validation-error"></div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Puzzle Management Panel -->
        <div class="panel">
            <h2>üóÇ Manage Daily Puzzles</h2>
            
            <div class="quick-actions">
                <input type="text" id="searchPuzzles" placeholder="üîç Search puzzles..." style="width: 300px;" oninput="filterPuzzles()">
                <button class="btn btn-secondary btn-small" onclick="loadPuzzles()">üîÑ Refresh</button>
                <button class="btn btn-secondary btn-small" onclick="exportPuzzles()">üì§ Export</button>
                <input type="file" id="importFile" accept=".json" onchange="importPuzzles()" style="display: none;">
                <button class="btn btn-secondary btn-small" onclick="document.getElementById('importFile').click()">üì• Import</button>
            </div>
            
            <div id="puzzleList" class="puzzle-list">
                <div style="text-align: center; padding: 20px;">Loading puzzles...</div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect environment
        const API_BASE = (window.location.hostname === 'localhost' || 
                          window.location.protocol === 'file:' ||
                          window.location.hostname === '127.0.0.1')
            ? 'http://localhost:3001/api'  // Local development
            : '/api';  // Production
        
        console.log('Current hostname:', window.location.hostname);
        console.log('Using API_BASE:', API_BASE);
        let authToken = null;
        let allPuzzles = [];

        // Format date to local date string (YYYY-MM-DD)
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Parse date string properly for display - FIXED
        function parseDisplayDate(dateString) {
            // Handle PostgreSQL date format properly
            const cleanDateString = dateString.split('T')[0]; // Remove time if present
            const [year, month, day] = cleanDateString.split('-').map(Number);
            return new Date(year, month - 1, day); // month is 0-indexed in JS
        }

        // Initialize
        function init() {
            authToken = localStorage.getItem('adminToken');
            if (authToken) {
                showDashboard();
            } else {
                showLogin();
            }
            
            document.getElementById('puzzleDate').value = formatLocalDate(new Date());
            document.getElementById('puzzleForm').addEventListener('submit', savePuzzle);
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });

            // Add real-time validation
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`answer${i}`).addEventListener('input', () => validateClue(i));
                document.getElementById(`linking${i}`).addEventListener('input', () => validateClue(i));
                document.getElementById(`clue${i}`).addEventListener('input', () => validateClue(i));
            }

            checkConnection();
            setInterval(checkConnection, 30000);
        }

        // Connection monitoring
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(isOnline) {
            const status = document.getElementById('connectionStatus');
            if (isOnline) {
                status.textContent = 'üü¢ Server Online';
                status.className = 'connection-status connection-online';
            } else {
                status.textContent = 'üî¥ Server Offline';
                status.className = 'connection-status connection-offline';
            }
        }

        // Authentication
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showMessage('loginError', 'Please enter username and password', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    showDashboard();
                } else {
                    showMessage('loginError', data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showMessage('loginError', 'Connection error. Is the server running on port 3001?', 'error');
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('adminToken');
            showLogin();
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            loadDashboardStats();
            loadPuzzles();
        }

        // API helper
        async function apiRequest(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || `API Error: ${response.status}`);
            }

            return response.json();
        }

        // Dashboard functions
        async function loadDashboardStats() {
            try {
                const stats = await apiRequest('/admin/dashboard');
                document.getElementById('totalPuzzles').textContent = stats.total_puzzles || 0;
                document.getElementById('futurePuzzles').textContent = stats.future_puzzles || 0;
                document.getElementById('todayPuzzle').textContent = stats.today_puzzle ? '‚úÖ' : '‚ùå';
                document.getElementById('todayPlays').textContent = stats.today_plays || 0;
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }

        async function loadPuzzles() {
            try {
                const puzzles = await apiRequest('/admin/daily-puzzles');
                allPuzzles = puzzles;
                renderPuzzleList(puzzles);
            } catch (error) {
                document.getElementById('puzzleList').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">‚ùå Failed to load puzzles</div>';
            }
        }

        function renderPuzzleList(puzzles) {
            const puzzleList = document.getElementById('puzzleList');
            
            if (puzzles.length === 0) {
                puzzleList.innerHTML = '<div style="text-align: center; padding: 20px;">üì≠ No daily puzzles found</div>';
                return;
            }

            puzzleList.innerHTML = puzzles.map(puzzle => {
                const displayDate = parseDisplayDate(puzzle.date);
                
                // Handle PostgreSQL date format (YYYY-MM-DD vs local date) - FIXED
                const todayString = new Date().toISOString().split('T')[0];
                const puzzleDateString = puzzle.date.split('T')[0]; // Handle both formats
                
                const isToday = puzzleDateString === todayString;
                const isPast = puzzleDateString < todayString;
                
                let statusIcon = 'üìÖ';
                let statusText = 'Future';
                if (isToday) {
                    statusIcon = 'üéØ';
                    statusText = 'Today';
                } else if (isPast) {
                    statusIcon = 'üìö';
                    statusText = 'Past';
                }

                if (!puzzle.is_active) {
                    statusIcon = 'üö´';
                    statusText = 'Inactive';
                }
                
                return `
                    <div class="puzzle-item">
                        <div class="puzzle-header">
                            <div class="puzzle-date">
                                ${statusIcon} ${displayDate.toLocaleDateString()} (${statusText})
                                ${puzzle.difficulty > 1 ? '‚≠ê'.repeat(puzzle.difficulty) : ''}
                            </div>
                            <div class="puzzle-actions">
                                <button class="btn btn-secondary btn-small" onclick="editPuzzle(${puzzle.id})">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger btn-small" onclick="deletePuzzle(${puzzle.id})">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div class="clues-preview">
                            ${puzzle.clues.map((clue, index) => `
                                <div class="clue-preview-item">
                                    <div class="clue-preview-text">${index + 1}. "${clue.clue}"</div>
                                    <div class="clue-preview-answer">‚Üí ${clue.answer} (${clue.linking_word})</div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="font-size: 0.8rem; color: #888; margin-top: 10px;">
                            üìä Plays: ${puzzle.completion_count || 0} | 
                            üìà Avg Score: ${puzzle.avg_score ? puzzle.avg_score.toFixed(1) : 'N/A'} |
                            üë§ Created by: ${puzzle.created_by_username || 'Admin'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Validation
        function validateClue(clueNumber) {
            const answer = document.getElementById(`answer${clueNumber}`).value.toUpperCase();
            const linking = document.getElementById(`linking${clueNumber}`).value.toUpperCase();
            const clue = document.getElementById(`clue${clueNumber}`).value;
            const validationElement = document.getElementById(`validation${clueNumber}`);

            validationElement.textContent = '';

            if (answer && linking && !answer.includes(linking)) {
                validationElement.textContent = '‚ùå Linking word must be in the answer';
                return false;
            }

            if (answer && clue) {
                const answerWords = answer.split(' ');
                const clueUpper = clue.toUpperCase();
                const forbiddenWords = answerWords.filter(word => 
                    word.length > 2 && clueUpper.includes(word)
                );

                if (forbiddenWords.length > 0) {
                    validationElement.textContent = `‚ùå Clue cannot contain: ${forbiddenWords.join(', ')}`;
                    return false;
                }
            }

            return true;
        }

        function validateAllClues() {
            let allValid = true;
            for (let i = 1; i <= 5; i++) {
                if (!validateClue(i)) {
                    allValid = false;
                }
            }
            
            if (allValid) {
                showMessage('puzzleFormSuccess', '‚úÖ All clues are valid!', 'success');
            } else {
                showMessage('puzzleFormError', '‚ùå Please fix validation errors', 'error');
            }
        }

        // Puzzle management
        async function savePuzzle(e) {
            e.preventDefault();
            
            const clues = [];
            for (let i = 1; i <= 5; i++) {
                clues.push({
                    clue: document.getElementById(`clue${i}`).value,
                    answer: document.getElementById(`answer${i}`).value.toUpperCase(),
                    linkingWord: document.getElementById(`linking${i}`).value.toUpperCase()
                });
            }

            const puzzleData = {
                date: document.getElementById('puzzleDate').value,
                difficulty: parseInt(document.getElementById('puzzleDifficulty').value),
                clues: clues
            };

            // Validate all clues
            let validationPassed = true;
            for (let i = 1; i <= 5; i++) {
                if (!validateClue(i)) {
                    validationPassed = false;
                }
            }

            if (!validationPassed) {
                showMessage('puzzleFormError', '‚ùå Please fix validation errors before saving', 'error');
                return;
            }

            try {
                const editingId = document.getElementById('editingPuzzleId').value;
                
                if (editingId) {
                    await apiRequest(`/admin/daily-puzzles/${editingId}`, {
                        method: 'PUT',
                        body: JSON.stringify(puzzleData)
                    });
                    showMessage('puzzleFormSuccess', '‚úÖ Daily puzzle updated successfully!', 'success');
                } else {
                    await apiRequest('/admin/daily-puzzles', {
                        method: 'POST',
                        body: JSON.stringify(puzzleData)
                    });
                    showMessage('puzzleFormSuccess', '‚úÖ Daily puzzle created successfully!', 'success');
                }
                
                clearForm();
                loadPuzzles();
                loadDashboardStats();
                
            } catch (error) {
                showMessage('puzzleFormError', '‚ùå ' + error.message, 'error');
            }
        }

        function editPuzzle(id) {
            const puzzle = allPuzzles.find(p => p.id === id);
            if (!puzzle) return;

            document.getElementById('editingPuzzleId').value = id;
            document.getElementById('puzzleDate').value = puzzle.date.split('T')[0]; // Handle PostgreSQL date format
            document.getElementById('puzzleDifficulty').value = puzzle.difficulty || 1;
            
            // Fill in clues
            puzzle.clues.forEach((clue, index) => {
                const clueNum = index + 1;
                document.getElementById(`clue${clueNum}`).value = clue.clue;
                document.getElementById(`answer${clueNum}`).value = clue.answer;
                document.getElementById(`linking${clueNum}`).value = clue.linking_word;
            });
            
            document.getElementById('submitBtn').textContent = 'Update Daily Puzzle';
            
            document.querySelector('.panel').scrollIntoView({ behavior: 'smooth' });
            showMessage('puzzleFormSuccess', 'üìù Editing daily puzzle - make changes and click Update', 'success');
        }

        async function deletePuzzle(id) {
            const puzzle = allPuzzles.find(p => p.id === id);
            const puzzleName = puzzle ? `Daily puzzle for ${parseDisplayDate(puzzle.date).toLocaleDateString()}` : 'this puzzle';
            
            if (!confirm(`Are you sure you want to delete ${puzzleName}?`)) return;

            try {
                await apiRequest(`/admin/daily-puzzles/${id}`, { method: 'DELETE' });
                loadPuzzles();
                loadDashboardStats();
                showMessage('puzzleFormSuccess', '‚úÖ Daily puzzle deleted successfully', 'success');
            } catch (error) {
                showMessage('puzzleFormError', '‚ùå Failed to delete: ' + error.message, 'error');
            }
        }

        function clearForm() {
            document.getElementById('puzzleForm').reset();
            document.getElementById('editingPuzzleId').value = '';
            document.getElementById('puzzleDate').value = formatLocalDate(new Date());
            document.getElementById('puzzleDifficulty').value = 1;
            document.getElementById('submitBtn').textContent = 'Create Daily Puzzle';
            
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`validation${i}`).textContent = '';
            }
            
            hideMessage('puzzleFormError');
            hideMessage('puzzleFormSuccess');
        }

        // Search and filter
        function filterPuzzles() {
            const query = document.getElementById('searchPuzzles').value.toLowerCase();
            const filteredPuzzles = allPuzzles.filter(puzzle => 
                puzzle.date.includes(query) ||
                puzzle.clues.some(clue => 
                    clue.clue.toLowerCase().includes(query) ||
                    clue.answer.toLowerCase().includes(query)
                )
            );
            renderPuzzleList(filteredPuzzles);
        }

        function generateSamplePuzzle() {
            const samples = [
                {
                    clue: "Device for pointing and clicking + Device to catch rodents",
                    answer: "COMPUTER MOUSE TRAP",
                    linking: "MOUSE"
                },
                {
                    clue: "Furniture for beverages + Book navigation aid",
                    answer: "COFFEE TABLE OF CONTENTS",
                    linking: "TABLE"
                },
                {
                    clue: "Sequential art series + Piece of breakfast meat",
                    answer: "COMIC STRIP OF BACON",
                    linking: "STRIP"
                },
                {
                    clue: "Ocean mammal + Observation area",
                    answer: "WHALE WATCHING DECK",
                    linking: "WATCHING"
                },
                {
                    clue: "Celestial body + Light beam",
                    answer: "MOON BEAM OF LIGHT",
                    linking: "BEAM"
                }
            ];

            samples.forEach((sample, index) => {
                const num = index + 1;
                document.getElementById(`clue${num}`).value = sample.clue;
                document.getElementById(`answer${num}`).value = sample.answer;
                document.getElementById(`linking${num}`).value = sample.linking;
            });

            showMessage('puzzleFormSuccess', '‚ú® Sample daily puzzle generated!', 'success');
        }

        function copyFromDate() {
            const copyDate = document.getElementById('copyFromDate').value;
            const copyStatus = document.getElementById('copyStatus');
            
            if (!copyDate) {
                copyStatus.innerHTML = '<span style="color: #dc3545;">Please select a date first</span>';
                return;
            }
            
            // Find puzzle with matching date in our loaded puzzles
            const sourcePuzzle = allPuzzles.find(p => p.date.split('T')[0] === copyDate);
            
            if (!sourcePuzzle) {
                copyStatus.innerHTML = '<span style="color: #dc3545;">No puzzle found for ' + copyDate + '</span>';
                return;
            }
            
            // Copy the clues (but NOT the date - keep the target date)
            sourcePuzzle.clues.forEach((clue, index) => {
                const clueNum = index + 1;
                document.getElementById(`clue${clueNum}`).value = clue.clue;
                document.getElementById(`answer${clueNum}`).value = clue.answer;
                document.getElementById(`linking${clueNum}`).value = clue.linking_word;
            });
            
            // Copy difficulty too
            document.getElementById('puzzleDifficulty').value = sourcePuzzle.difficulty || 1;
            
            copyStatus.innerHTML = '<span style="color: #155724;">‚úì Copied clues from ' + copyDate + '</span>';
            showMessage('puzzleFormSuccess', 'üìã Clues copied! Adjust the date and save as new puzzle.', 'success');
        }

        function exportPuzzles() {
            const exportData = allPuzzles.map(p => ({
                date: p.date.split('T')[0], // Clean date format
                difficulty: p.difficulty,
                clues: p.clues.map(c => ({
                    clue: c.clue,
                    answer: c.answer,
                    linkingWord: c.linking_word
                }))
            }));

            const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `phrasey-chain-daily-puzzles-${formatLocalDate(new Date())}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('puzzleFormSuccess', `üì¶ Exported ${exportData.length} daily puzzles`, 'success');
        }

        function importPuzzles() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const dailyPuzzles = JSON.parse(e.target.result);
                    
                    const response = await apiRequest('/admin/daily-puzzles/bulk-import', {
                        method: 'POST',
                        body: JSON.stringify({ dailyPuzzles })
                    });
                    
                    showMessage('puzzleFormSuccess', 
                        `Import complete: ${response.successful} successful, ${response.failed} failed`, 
                        response.failed > 0 ? 'error' : 'success');
                    
                    if (response.successful > 0) {
                        loadPuzzles();
                        loadDashboardStats();
                    }
                    
                } catch (error) {
                    showMessage('puzzleFormError', 'Import failed: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Utility functions
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = type === 'error' ? 'error-message' : 'success-message';
            element.style.display = 'block';
            
            setTimeout(() => hideMessage(elementId), 8000);
        }

        function hideMessage(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        // Initialize when page loads
        init();
    </script>
</body>
</html>
