<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clue Library - Puzzle Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 18px;
            color: #6c757d;
        }

        .tabs {
            display: flex;
            margin-bottom: 32px;
            background: white;
            border-radius: 12px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 12px 24px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #007AFF;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #f8f9fa;
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .panel h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #1a1a1a;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: linear-gradient(135deg, #007AFF 0%, #0051D0 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .form-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007AFF;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0051D0;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .clue-list {
            display: grid;
            gap: 16px;
            margin-top: 24px;
        }

        .clue-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .clue-item:hover {
            border-color: #007AFF;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,122,255,0.15);
        }

        .clue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .clue-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .clue-answer {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 18px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 4px;
        }

        .clue-linking {
            font-size: 14px;
            color: #FF9500;
            font-weight: 600;
        }

        .clue-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6c757d;
            margin-top: 12px;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
        }

        .tag.difficulty-1 { background: #d4edda; color: #155724; }
        .tag.difficulty-2 { background: #fff3cd; color: #856404; }
        .tag.difficulty-3 { background: #f8d7da; color: #721c24; }

        .bulk-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-filter input,
        .search-filter select {
            flex: 1;
            min-width: 200px;
        }

        .hidden {
            display: none !important;
        }

        .puzzle-builder {
            background: #f8f9fa;
            border: 2px dashed #007AFF;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            margin-bottom: 24px;
        }

        .puzzle-preview {
            display: grid;
            gap: 12px;
            margin-top: 24px;
        }

        .preview-clue {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #007AFF;
        }

        .success-message, .error-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .clue-options-grid {
            display: grid;
            gap: 12px;
            margin: 16px 0;
        }

        .clue-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clue-option:hover {
            border-color: #007AFF;
            transform: translateY(-1px);
        }

        .clue-option.selected {
            border-color: #007AFF;
            background: #f0f8ff;
        }

        .clue-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .clue-style-tag {
            background: #007AFF;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .confidence-score {
            font-size: 12px;
            color: #6c757d;
        }

        .clue-option-text {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .phrase-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .phrase-item input[type="checkbox"] {
            margin-right: 12px;
        }

        .phrase-item.selected {
            border-color: #28a745;
            background: #f0fff4;
        }

        .phrase-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .phrase-answer {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 18px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 4px;
        }

        .phrase-linking {
            font-size: 14px;
            color: #FF9500;
            font-weight: 600;
        }

        .ai-loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .ai-loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #007AFF;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧩 Clue Library</h1>
            <p>Build your puzzle content library and generate daily puzzles effortlessly</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('library')">📚 Library</button>
            <button class="tab" onclick="switchTab('builder')">🔨 Builder</button>
            <button class="tab" onclick="switchTab('ai')">🤖 AI Generator</button>
            <button class="tab" onclick="switchTab('generator')">✨ Puzzle Generator</button>
        </div>

        <!-- Library Tab -->
        <div id="library-tab" class="tab-content">
            <div class="panel">
                <h2>Library Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClues">0</div>
                        <div class="stat-label">Total Clues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="unusedClues">0</div>
                        <div class="stat-label">Unused Clues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="possiblePuzzles">0</div>
                        <div class="stat-label">Possible Puzzles</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="daysOfContent">0</div>
                        <div class="stat-label">Days of Content</div>
                    </div>
                </div>

                <div class="bulk-actions">
                    <button class="btn btn-primary" onclick="showAddClueForm()">+ Add Clue</button>
                    <button class="btn btn-secondary btn-small" onclick="importClues()">📥 Import CSV</button>
                    <button class="btn btn-secondary btn-small" onclick="exportClues()">📤 Export</button>
                    <button class="btn btn-success btn-small" onclick="showAIGenerator()">🤖 AI Generate</button>
                    <button class="btn btn-success btn-small" onclick="improveExistingClues()">✨ Improve Clues</button>
                </div>

                <div class="search-filter">
                    <input type="text" id="searchClues" placeholder="🔍 Search clues..." oninput="filterClues()">
                    <select id="filterDifficulty" onchange="filterClues()">
                        <option value="">All Difficulties</option>
                        <option value="1">Easy</option>
                        <option value="2">Medium</option>
                        <option value="3">Hard</option>
                    </select>
                    <select id="filterUsed" onchange="filterClues()">
                        <option value="">All Clues</option>
                        <option value="false">Unused Only</option>
                        <option value="true">Used Only</option>
                    </select>
                </div>

                <div id="cluesList" class="clue-list">
                    <!-- Clues will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Builder Tab -->
        <div id="builder-tab" class="tab-content hidden">
            <div class="panel">
                <h2>Add New Clue</h2>
                <form id="clueForm">
                    <div class="form-section">
                        <div class="form-group">
                            <label for="clueText">Clue Text (Format: "clue 1 + clue 2")</label>
                            <textarea id="clueText" placeholder="Hawaiian '24k' pop star + Campy sci-fi invasion movie" required></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="clueAnswer">Answer</label>
                                <input type="text" id="clueAnswer" placeholder="BRUNO MARS ATTACKS" style="text-transform: uppercase;" required>
                            </div>
                            <div class="form-group">
                                <label for="clueLinking">Linking Word</label>
                                <input type="text" id="clueLinking" placeholder="MARS" style="text-transform: uppercase;" required>
                            </div>
                            <div class="form-group">
                                <label for="clueDifficulty">Difficulty</label>
                                <select id="clueDifficulty" required>
                                    <option value="1">Easy</option>
                                    <option value="2">Medium</option>
                                    <option value="3">Hard</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="clueCategory">Category (Optional)</label>
                                <input type="text" id="clueCategory" placeholder="e.g., Entertainment, Movies, Food">
                            </div>
                            <div class="form-group">
                                <label for="clueTags">Tags (Optional)</label>
                                <input type="text" id="clueTags" placeholder="Comma-separated tags">
                            </div>
                        </div>
                    </div>

                    <div class="bulk-actions">
                        <button type="submit" class="btn btn-primary">Save Clue</button>
                        <button type="button" class="btn btn-secondary" onclick="resetClueForm()">Clear</button>
                    </div>
                </form>
                
                <div id="clueFormMessages"></div>
            </div>
        </div>

        <!-- AI Generator Tab -->
        <div id="ai-tab" class="tab-content hidden">
            <div class="panel">
                <h2>🤖 AI Clue Generation</h2>
                <p style="margin-bottom: 24px; color: #6c757d;">Generate creative clues for existing answers or create entirely new Before & After phrases</p>

                <div class="form-section">
                    <h3>Generate Clues for Existing Answer</h3>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="form-group">
                            <label for="aiAnswer">Before & After Answer</label>
                            <input type="text" id="aiAnswer" placeholder="BRUNO MARS ATTACKS" style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="clueCount">Number of Clue Options</label>
                            <select id="clueCount">
                                <option value="3">3 options</option>
                                <option value="5">5 options</option>
                                <option value="7">7 options</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateCluesForAnswer()">🎯 Generate Clues</button>
                </div>

                <div id="clueOptions" class="hidden" style="margin: 24px 0;">
                    <h3>Generated Clue Options</h3>
                    <div id="clueOptionsList" class="clue-options-grid">
                        <!-- Generated options will appear here -->
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-success" onclick="saveSelectedClue()">✅ Save Best Clue</button>
                        <button class="btn btn-secondary" onclick="regenerateClues()">🔄 Generate More</button>
                    </div>
                </div>

                <div class="form-section" style="border-top: 2px solid #e9ecef; padding-top: 32px;">
                    <h3>Generate New Before & After Phrases</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="form-group">
                            <label for="aiThemes">Themes (Optional)</label>
                            <input type="text" id="aiThemes" placeholder="e.g., movies, food, sports">
                        </div>
                        <div class="form-group">
                            <label for="phraseCount">Number of Phrases</label>
                            <select id="phraseCount">
                                <option value="5">5 phrases</option>
                                <option value="10">10 phrases</option>
                                <option value="20">20 phrases</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="aiDifficulty">Difficulty</label>
                            <select id="aiDifficulty">
                                <option value="mixed">Mixed</option>
                                <option value="1">Easy</option>
                                <option value="2">Medium</option>
                                <option value="3">Hard</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateNewPhrases()">🚀 Generate New Phrases</button>
                </div>

                <div id="newPhrases" class="hidden" style="margin: 24px 0;">
                    <h3>Generated New Phrases</h3>
                    <div id="newPhrasesList" class="clue-list">
                        <!-- New phrases will appear here -->
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-success" onclick="saveSelectedPhrases()">✅ Save Selected</button>
                        <button class="btn btn-secondary" onclick="generateNewPhrases()">🔄 Generate More</button>
                    </div>
                </div>

                <div class="form-section" style="border-top: 2px solid #e9ecef; padding-top: 32px;">
                    <h3>Batch Improve Existing Clues</h3>
                    <p style="margin-bottom: 16px; color: #6c757d;">AI will improve clues that are currently template-based or low quality</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="form-group">
                            <label for="batchLimit">Number to Process</label>
                            <select id="batchLimit">
                                <option value="10">10 clues</option>
                                <option value="25">25 clues</option>
                                <option value="50">50 clues</option>
                                <option value="100">100 clues</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="overwriteGood"> Overwrite good clues too
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="batchImproveClues()">⚡ Batch Improve</button>
                </div>

                <div id="aiMessages"></div>
            </div>
        </div>

        <!-- Puzzle Generator Tab -->
        <div id="generator-tab" class="tab-content hidden">
            <div class="panel">
                <h2>Smart Puzzle Generator</h2>
                <p style="margin-bottom: 24px; color: #6c757d;">Automatically generate daily puzzles from your clue library</p>

                <div class="puzzle-builder">
                    <h3>Generate New Puzzle</h3>
                    <p style="margin-bottom: 24px;">Click to automatically select 5 unused clues and create a daily puzzle</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <div class="form-group">
                            <label for="generateDate">Date</label>
                            <input type="date" id="generateDate" required>
                        </div>
                        <div class="form-group">
                            <label for="generateDifficulty">Target Difficulty</label>
                            <select id="generateDifficulty">
                                <option value="mixed">Mixed (Recommended)</option>
                                <option value="1">Easy</option>
                                <option value="2">Medium</option>
                                <option value="3">Hard</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="generateTheme">Theme (Optional)</label>
                            <input type="text" id="generateTheme" placeholder="e.g., Movies, 80s">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="generatePuzzle()">🎲 Generate Puzzle</button>
                </div>

                <div id="puzzlePreview" class="puzzle-preview hidden">
                    <h3>Preview Generated Puzzle</h3>
                    <div id="previewClues"></div>
                    <div style="margin-top: 24px;">
                        <button class="btn btn-success" onclick="savePuzzle()">✅ Save Puzzle</button>
                        <button class="btn btn-secondary" onclick="generatePuzzle()">🔄 Regenerate</button>
                    </div>
                </div>

                <div id="generatorMessages"></div>
            </div>

            <div class="panel">
                <h2>Bulk Generator</h2>
                <p style="margin-bottom: 24px; color: #6c757d;">Generate multiple puzzles at once</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div class="form-group">
                        <label for="bulkStartDate">Start Date</label>
                        <input type="date" id="bulkStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="bulkCount">Number of Puzzles</label>
                        <input type="number" id="bulkCount" value="7" min="1" max="30">
                    </div>
                    <div class="form-group">
                        <label for="bulkDifficulty">Difficulty Mix</label>
                        <select id="bulkDifficulty">
                            <option value="mixed">Mixed Difficulty</option>
                            <option value="easy">Mostly Easy</option>
                            <option value="medium">Mostly Medium</option>
                            <option value="hard">Mostly Hard</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="bulkGeneratePuzzles()">🚀 Generate Week of Puzzles</button>
                <div id="bulkGeneratorMessages"></div>
            </div>
        </div>

        <!-- Hidden file input for CSV import -->
        <input type="file" id="csvImport" accept=".csv" style="display: none;" onchange="handleCSVImport()">
    </div>

    <script>
        // Auto-detect API environment
        const API_BASE = (window.location.hostname === 'localhost' || 
                          window.location.protocol === 'file:' ||
                          window.location.hostname === '127.0.0.1')
            ? 'http://localhost:3001/api'
            : '/api';

        // Simulated data - will be replaced with real API calls
        let clueLibrary = [];
        let generatedPuzzle = null;
        let selectedClueOption = null;
        let selectedNewPhrases = [];

        // Initialize
        function init() {
            loadClues();
            updateStats();
            setDefaultDates();
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        }

        // Load clues from API
        async function loadClues() {
            try {
                const response = await fetch(`${API_BASE}/clue-library/clues`);
                const data = await response.json();
                
                if (data.clues) {
                    clueLibrary = data.clues;
                    displayClues();
                    updateStats();
                } else {
                    showMessage('clueFormMessages', 'Failed to load clues from server', 'error');
                }
            } catch (error) {
                console.error('Error loading clues:', error);
                // Use test data if API fails
                loadTestData();
            }
        }

        // Load test data as fallback
        function loadTestData() {
            clueLibrary = [
                {
                    id: 1,
                    clue: "Hawaiian '24k' pop star + Campy sci-fi invasion movie",
                    answer: "BRUNO MARS ATTACKS",
                    linking_word: "MARS",
                    difficulty: 2,
                    category: "Entertainment",
                    used: false,
                    created_at: "2024-01-15"
                },
                {
                    id: 2,
                    clue: "Alien's famous phone request + Orange-aproned hardware store",
                    answer: "E.T. PHONE HOME DEPOT",
                    linking_word: "HOME",
                    difficulty: 2,
                    category: "Movies",
                    used: false,
                    created_at: "2024-01-15"
                },
                {
                    id: 3,
                    clue: "Plastic toy with removable parts + Squad's top spirit leader",
                    answer: "MR. POTATO HEAD CHEERLEADER",
                    linking_word: "HEAD",
                    difficulty: 2,
                    category: "Entertainment",
                    used: false,
                    created_at: "2024-01-10"
                }
            ];
            displayClues();
            updateStats();
        }

        // Update library stats
        function updateStats() {
            const totalClues = clueLibrary.length;
            const unusedClues = clueLibrary.filter(clue => !clue.used).length;
            const possiblePuzzles = Math.floor(unusedClues / 5);
            const daysOfContent = possiblePuzzles;

            document.getElementById('totalClues').textContent = totalClues;
            document.getElementById('unusedClues').textContent = unusedClues;
            document.getElementById('possiblePuzzles').textContent = possiblePuzzles;
            document.getElementById('daysOfContent').textContent = daysOfContent;
        }

        // Display clues in the library
        function displayClues() {
            const container = document.getElementById('cluesList');
            const filteredClues = getFilteredClues();
            
            if (filteredClues.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <h3>No clues found</h3>
                        <p>Try adjusting your filters or add some clues to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredClues.map(clue => `
                <div class="clue-item">
                    <div class="clue-header">
                        <div>
                            <span class="tag difficulty-${clue.difficulty}">
                                ${['Easy', 'Medium', 'Hard'][clue.difficulty - 1]}
                            </span>
                            ${clue.category ? `<span class="tag">${clue.category}</span>` : ''}
                            ${clue.used ? '<span class="tag" style="background: #f8d7da; color: #721c24;">Used</span>' : ''}
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="editClue(${clue.id})">Edit</button>
                    </div>
                    <div class="clue-text">${clue.clue}</div>
                    <div class="clue-answer">${clue.answer}</div>
                    <div class="clue-linking">Linking word: ${clue.linking_word}</div>
                    <div class="clue-meta">
                        <span>Added: ${formatDate(clue.created_at)}</span>
                        <span>${clue.last_used ? `Last used: ${formatDate(clue.last_used)}` : 'Never used'}</span>
                    </div>
                </div>
            `).join('');
        }

        // Filter clues
        function getFilteredClues() {
            let filtered = [...clueLibrary];
            
            const search = document.getElementById('searchClues')?.value.toLowerCase() || '';
            const difficulty = document.getElementById('filterDifficulty')?.value || '';
            const used = document.getElementById('filterUsed')?.value || '';

            if (search) {
                filtered = filtered.filter(clue => 
                    clue.clue.toLowerCase().includes(search) ||
                    clue.answer.toLowerCase().includes(search) ||
                    clue.category?.toLowerCase().includes(search)
                );
            }

            if (difficulty) {
                filtered = filtered.filter(clue => clue.difficulty == difficulty);
            }

            if (used !== '') {
                filtered = filtered.filter(clue => clue.used == (used === 'true'));
            }

            return filtered;
        }

        function filterClues() {
            displayClues();
        }

        // ===== CLUE FORM HANDLING =====

        function showAddClueForm() {
            switchTab('builder');
        }

        function resetClueForm() {
            document.getElementById('clueForm').reset();
        }

        document.getElementById('clueForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                clue: document.getElementById('clueText').value,
                answer: document.getElementById('clueAnswer').value.toUpperCase(),
                linking_word: document.getElementById('clueLinking').value.toUpperCase(),
                difficulty: parseInt(document.getElementById('clueDifficulty').value),
                category: document.getElementById('clueCategory').value,
                tags: document.getElementById('clueTags').value.split(',').map(t => t.trim()).filter(t => t)
            };

            // Validation
            if (!formData.answer.includes(formData.linking_word)) {
                showMessage('clueFormMessages', 'Error: Linking word must appear in the answer', 'error');
                return;
            }

            // Add to library (simulate API call for now)
            const newClue = {
                id: clueLibrary.length + 1,
                ...formData,
                used: false,
                created_at: new Date().toISOString().split('T')[0],
                last_used: null
            };

            clueLibrary.push(newClue);
            updateStats();
            displayClues();
            resetClueForm();
            
            showMessage('clueFormMessages', 'Clue added successfully! 🎉', 'success');
        });

        // ===== AI GENERATION FUNCTIONS =====

        function showAIGenerator() {
            switchTab('ai');
        }

        async function generateCluesForAnswer() {
            const answer = document.getElementById('aiAnswer').value.trim().toUpperCase();
            const count = parseInt(document.getElementById('clueCount').value);

            if (!answer) {
                showMessage('aiMessages', 'Please enter a Before & After answer', 'error');
                return;
            }

            // Show loading
            document.getElementById('clueOptions').classList.remove('hidden');
            document.getElementById('clueOptionsList').innerHTML = '<div class="ai-loading">🤖 Generating creative clues...</div>';

            try {
                const response = await fetch(`${API_BASE}/ai-clue-generator/generate-clues`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer, count })
                });

                const data = await response.json();
                
                if (data.error) {
                    showMessage('aiMessages', 'Error: ' + data.error, 'error');
                    return;
                }

                displayClueOptions(data.clue_options, answer);
                
            } catch (error) {
                console.error('Error generating clues:', error);
                showMessage('aiMessages', 'Failed to generate clues. Please try again.', 'error');
            }
        }

        function displayClueOptions(clueOptions, answer) {
            const container = document.getElementById('clueOptionsList');
            
            container.innerHTML = clueOptions.map((option, index) => `
                <div class="clue-option" onclick="selectClueOption(${index})">
                    <div class="clue-option-header">
                        <span class="clue-style-tag">${option.style}</span>
                        <span class="confidence-score">Confidence: ${Math.round(option.confidence * 100)}%</span>
                    </div>
                    <div class="clue-option-text">${option.clue}</div>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 8px;">
                        Answer: ${answer} | Linking: ${option.linking_word}
                    </div>
                </div>
            `).join('');

            // Auto-select the highest confidence option
            if (clueOptions.length > 0) {
                selectClueOption(0);
            }
        }

        function selectClueOption(index) {
            // Remove previous selection
            document.querySelectorAll('.clue-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Select new option
            const selectedElement = document.querySelectorAll('.clue-option')[index];
            selectedElement.classList.add('selected');
            
            selectedClueOption = index;
        }

        function regenerateClues() {
            generateCluesForAnswer();
        }

        async function saveSelectedClue() {
            if (selectedClueOption === null) {
                showMessage('aiMessages', 'Please select a clue option first', 'error');
                return;
            }

            const answer = document.getElementById('aiAnswer').value.trim().toUpperCase();
            const clueElements = document.querySelectorAll('.clue-option');
            const selectedElement = clueElements[selectedClueOption];
            
            const clueText = selectedElement.querySelector('.clue-option-text').textContent;
            const linkingWordText = selectedElement.textContent;
            const linkingWord = linkingWordText.split('Linking: ')[1] || '';

            // Add to clue library
            const newClue = {
                id: clueLibrary.length + 1,
                clue: clueText,
                answer: answer,
                linking_word: linkingWord,
                difficulty: calculateDifficulty({ answer }),
                category: 'AI Generated',
                tags: ['ai-generated', 'before-and-after'],
                used: false,
                created_at: new Date().toISOString().split('T')[0],
                last_used: null
            };

            clueLibrary.push(newClue);
            updateStats();
            displayClues();

            showMessage('aiMessages', '🎉 Clue saved to library successfully!', 'success');
            
            // Reset form
            document.getElementById('aiAnswer').value = '';
            document.getElementById('clueOptions').classList.add('hidden');
            selectedClueOption = null;
        }

        async function generateNewPhrases() {
            const themes = document.getElementById('aiThemes').value.split(',').map(t => t.trim()).filter(t => t);
            const count = parseInt(document.getElementById('phraseCount').value);
            const difficulty = document.getElementById('aiDifficulty').value;

            // Show loading
            document.getElementById('newPhrases').classList.remove('hidden');
            document.getElementById('newPhrasesList').innerHTML = '<div class="ai-loading">🚀 Creating new Before & After phrases...</div>';

            try {
                const response = await fetch(`${API_BASE}/ai-clue-generator/generate-phrases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ themes, count, difficulty })
                });

                const data = await response.json();
                
                if (data.error) {
                    showMessage('aiMessages', 'Error: ' + data.error, 'error');
                    return;
                }

                displayNewPhrases(data.phrases);
                
            } catch (error) {
                console.error('Error generating phrases:', error);
                showMessage('aiMessages', 'Failed to generate new phrases. Please try again.', 'error');
            }
        }

        function displayNewPhrases(phrases) {
            const container = document.getElementById('newPhrasesList');
            
            container.innerHTML = phrases.map((phrase, index) => `
                <div class="phrase-item" onclick="togglePhraseSelection(${index})">
                    <div class="phrase-header">
                        <input type="checkbox" id="phrase_${index}" onchange="togglePhraseSelection(${index})">
                        <label for="phrase_${index}" style="flex: 1;">
                            <div class="phrase-answer">${phrase.answer}</div>
                            <div class="phrase-linking">Linking word: ${phrase.linking_word}</div>
                            ${phrase.generated ? '<span class="tag">AI Generated</span>' : ''}
                            <span class="confidence-score">Confidence: ${Math.round(phrase.confidence * 100)}%</span>
                        </label>
                    </div>
                </div>
            `).join('');

            selectedNewPhrases = [];
        }

        function togglePhraseSelection(index) {
            const checkbox = document.getElementById(`phrase_${index}`);
            const phraseItem = checkbox.closest('.phrase-item');
            
            if (checkbox.checked) {
                phraseItem.classList.add('selected');
                if (!selectedNewPhrases.includes(index)) {
                    selectedNewPhrases.push(index);
                }
            } else {
                phraseItem.classList.remove('selected');
                selectedNewPhrases = selectedNewPhrases.filter(i => i !== index);
            }
        }

        async function saveSelectedPhrases() {
            if (selectedNewPhrases.length === 0) {
                showMessage('aiMessages', 'Please select at least one phrase to save', 'error');
                return;
            }

            const phrases = document.querySelectorAll('.phrase-item');
            let saved = 0;

            selectedNewPhrases.forEach(index => {
                const phraseElement = phrases[index];
                const answer = phraseElement.querySelector('.phrase-answer').textContent;
                const linkingText = phraseElement.querySelector('.phrase-linking').textContent;
                const linkingWord = linkingText.replace('Linking word: ', '');

                // Generate a clue for this phrase
                const clue = `Before & After phrase combining two terms that share "${linkingWord}"`;

                const newClue = {
                    id: clueLibrary.length + saved + 1,
                    clue: clue,
                    answer: answer,
                    linking_word: linkingWord,
                    difficulty: calculateDifficulty({ answer }),
                    category: 'AI Generated',
                    tags: ['ai-generated', 'before-and-after', 'new-phrase'],
                    used: false,
                    created_at: new Date().toISOString().split('T')[0],
                    last_used: null
                };

                clueLibrary.push(newClue);
                saved++;
            });

            updateStats();
            displayClues();

            showMessage('aiMessages', `🎉 Saved ${saved} new phrases to library!`, 'success');
            
            // Reset
            document.getElementById('newPhrases').classList.add('hidden');
            document.getElementById('aiThemes').value = '';
            selectedNewPhrases = [];
        }

        async function batchImproveClues() {
            const limit = parseInt(document.getElementById('batchLimit').value);
            const overwrite = document.getElementById('overwriteGood').checked;

            if (!confirm(`This will improve up to ${limit} clues using AI. Continue?`)) {
                return;
            }

            showMessage('aiMessages', `⚡ Starting batch improvement of ${limit} clues...`, 'success');

            try {
                const response = await fetch(`${API_BASE}/ai-clue-generator/batch-generate-clues`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit, overwrite })
                });

                const data = await response.json();
                
                if (data.error) {
                    showMessage('aiMessages', 'Error: ' + data.error, 'error');
                    return;
                }

                showMessage('aiMessages', 
                    `✅ Batch complete! Updated ${data.updated} out of ${data.processed} clues.`, 
                    'success');
                
                // Reload the library to show improvements
                loadClues();
                
            } catch (error) {
                console.error('Error in batch improvement:', error);
                showMessage('aiMessages', 'Batch improvement failed. Please try again.', 'error');
            }
        }

        async function improveExistingClues() {
            const unusedClues = clueLibrary.filter(clue => !clue.used && clue.clue.includes('Before & After'));
            
            if (unusedClues.length === 0) {
                showMessage('aiMessages', 'No template-based clues found to improve.', 'error');
                return;
            }

            if (!confirm(`Found ${unusedClues.length} clues that could be improved. Start AI enhancement?`)) {
                return;
            }

            batchImproveClues();
        }

        // ===== PUZZLE GENERATION FUNCTIONS =====

        function setDefaultDates() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            document.getElementById('generateDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('bulkStartDate').value = tomorrow.toISOString().split('T')[0];
        }

        function generatePuzzle() {
            const unusedClues = clueLibrary.filter(clue => !clue.used);
            
            if (unusedClues.length < 5) {
                showMessage('generatorMessages', 'Error: Need at least 5 unused clues to generate a puzzle', 'error');
                return;
            }

            // Smart selection based on difficulty preference
            const targetDifficulty = document.getElementById('generateDifficulty').value;
            const theme = document.getElementById('generateTheme').value;
            
            let selectedClues = smartSelectClues(unusedClues, targetDifficulty, theme);
            
            generatedPuzzle = {
                date: document.getElementById('generateDate').value,
                difficulty: calculateAverageDifficulty(selectedClues),
                clues: selectedClues.map((clue, index) => ({
                    clue_number: index + 1,
                    clue: clue.clue,
                    answer: clue.answer,
                    linking_word: clue.linking_word,
                    source_clue_id: clue.id
                }))
            };

            displayPuzzlePreview();
        }

        function smartSelectClues(availableClues, targetDifficulty, theme) {
            let selected = [];
            let remaining = [...availableClues];
            
            // Filter by theme if specified
            if (theme) {
                const themeClues = remaining.filter(clue => 
                    clue.category?.toLowerCase().includes(theme.toLowerCase()) ||
                    clue.tags?.some(tag => tag.toLowerCase().includes(theme.toLowerCase()))
                );
                if (themeClues.length >= 5) {
                    remaining = themeClues;
                }
            }

            if (targetDifficulty === 'mixed') {
                // Select 1-2 easy, 2-3 medium, 1-2 hard
                selected.push(...selectByDifficulty(remaining, 1, 2));
                selected.push(...selectByDifficulty(remaining, 2, 2));
                selected.push(...selectByDifficulty(remaining, 3, 1));
            } else if (targetDifficulty !== 'mixed') {
                const difficulty = parseInt(targetDifficulty);
                selected = selectByDifficulty(remaining, difficulty, 5);
            }

            // Fill remaining slots if needed
            while (selected.length < 5 && remaining.length > 0) {
                const randomClue = remaining[Math.floor(Math.random() * remaining.length)];
                if (!selected.includes(randomClue)) {
                    selected.push(randomClue);
                }
                remaining = remaining.filter(clue => clue !== randomClue);
            }

            return selected.slice(0, 5);
        }

        function selectByDifficulty(clues, difficulty, count) {
            const filtered = clues.filter(clue => clue.difficulty === difficulty);
            const shuffled = filtered.sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }

        function calculateAverageDifficulty(clues) {
            const sum = clues.reduce((acc, clue) => acc + clue.difficulty, 0);
            return Math.round(sum / clues.length);
        }

        function calculateDifficulty(data) {
            const answer = data.answer || '';
            const words = answer.split(' ').length;
            const avgWordLength = answer.replace(/ /g, '').length / words;
            const hasPunctuation = /[&',.-]/.test(answer);
            
            let difficulty = 1;
            if (words > 5) difficulty++;
            if (avgWordLength > 6) difficulty++;
            if (hasPunctuation) difficulty++;
            
            return Math.min(3, difficulty);
        }

        function displayPuzzlePreview() {
            const container = document.getElementById('previewClues');
            
            container.innerHTML = generatedPuzzle.clues.map(clue => `
                <div class="preview-clue">
                    <strong>Clue ${clue.clue_number}:</strong> ${clue.clue}
                    <div style="margin-top: 8px; font-family: Monaco, monospace; color: #007AFF;">
                        <strong>Answer:</strong> ${clue.answer} (Linking: ${clue.linking_word})
                    </div>
                </div>
            `).join('');

            document.getElementById('puzzlePreview').classList.remove('hidden');
        }

        function savePuzzle() {
            if (!generatedPuzzle) {
                showMessage('generatorMessages', 'Error: No puzzle to save', 'error');
                return;
            }

            // Mark clues as used (simulate API call)
            generatedPuzzle.clues.forEach(clue => {
                const libraryClue = clueLibrary.find(c => c.id === clue.source_clue_id);
                if (libraryClue) {
                    libraryClue.used = true;
                    libraryClue.last_used = generatedPuzzle.date;
                }
            });

            updateStats();
            displayClues();
            document.getElementById('puzzlePreview').classList.add('hidden');
            
            showMessage('generatorMessages', '🎉 Puzzle saved successfully!', 'success');
            
            // Reset form
            const tomorrow = new Date(new Date().getTime() + 24 * 60 * 60 * 1000);
            document.getElementById('generateDate').value = tomorrow.toISOString().split('T')[0];
        }

        function bulkGeneratePuzzles() {
            const startDate = new Date(document.getElementById('bulkStartDate').value);
            const count = parseInt(document.getElementById('bulkCount').value);
            const difficultyMix = document.getElementById('bulkDifficulty').value;
            
            const unusedClues = clueLibrary.filter(clue => !clue.used);
            const neededClues = count * 5;
            
            if (unusedClues.length < neededClues) {
                showMessage('bulkGeneratorMessages', 
                    `Error: Need ${neededClues} unused clues but only have ${unusedClues.length}`, 
                    'error');
                return;
            }

            const generatedPuzzles = [];
            let availableClues = [...unusedClues];

            for (let i = 0; i < count; i++) {
                const puzzleDate = new Date(startDate);
                puzzleDate.setDate(startDate.getDate() + i);
                
                const targetDifficulty = getDifficultyForMix(difficultyMix, i);
                const selectedClues = smartSelectClues(availableClues, targetDifficulty, '');
                
                // Remove selected clues from available pool
                availableClues = availableClues.filter(clue => !selectedClues.includes(clue));
                
                generatedPuzzles.push({
                    date: puzzleDate.toISOString().split('T')[0],
                    difficulty: calculateAverageDifficulty(selectedClues),
                    clues: selectedClues.map((clue, index) => ({
                        clue_number: index + 1,
                        clue: clue.clue,
                        answer: clue.answer,
                        linking_word: clue.linking_word,
                        source_clue_id: clue.id
                    }))
                });

                // Mark clues as used
                selectedClues.forEach(clue => {
                    const libraryClue = clueLibrary.find(c => c.id === clue.id);
                    if (libraryClue) {
                        libraryClue.used = true;
                        libraryClue.last_used = puzzleDate.toISOString().split('T')[0];
                    }
                });
            }

            updateStats();
            displayClues();
            
            showMessage('bulkGeneratorMessages', 
                `🚀 Successfully generated ${count} puzzles from ${startDate.toDateString()}!`, 
                'success');
        }

        function getDifficultyForMix(mix, dayIndex) {
            switch (mix) {
                case 'easy': return Math.random() < 0.7 ? 'mixed' : '1';
                case 'medium': return Math.random() < 0.7 ? 'mixed' : '2';
                case 'hard': return Math.random() < 0.7 ? 'mixed' : '3';
                default: return 'mixed';
            }
        }

        // ===== IMPORT/EXPORT FUNCTIONS =====

        function importClues() {
            document.getElementById('csvImport').click();
        }

        function handleCSVImport() {
            const file = document.getElementById('csvImport').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    let imported = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        if (values.length >= 3) {
                            const newClue = {
                                id: clueLibrary.length + imported + 1,
                                clue: values[0],
                                answer: values[1].toUpperCase(),
                                linking_word: values[2].toUpperCase(),
                                difficulty: parseInt(values[3]) || 2,
                                category: values[4] || '',
                                tags: values[5] ? values[5].split(';').map(t => t.trim()) : [],
                                used: false,
                                created_at: new Date().toISOString().split('T')[0],
                                last_used: null
                            };
                            
                            if (newClue.answer.includes(newClue.linking_word)) {
                                clueLibrary.push(newClue);
                                imported++;
                            }
                        }
                    }
                    
                    updateStats();
                    displayClues();
                    showMessage('clueFormMessages', `✅ Imported ${imported} clues from CSV`, 'success');
                    
                } catch (error) {
                    showMessage('clueFormMessages', 'Error importing CSV: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function exportClues() {
            const csvContent = [
                'Clue,Answer,Linking Word,Difficulty,Category,Tags',
                ...clueLibrary.map(clue => [
                    `"${clue.clue}"`,
                    clue.answer,
                    clue.linking_word,
                    clue.difficulty,
                    clue.category || '',
                    clue.tags ? clue.tags.join(';') : ''
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clue-library-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===== UTILITY FUNCTIONS =====

        function editClue(id) {
            const clue = clueLibrary.find(c => c.id === id);
            if (clue) {
                document.getElementById('clueText').value = clue.clue;
                document.getElementById('clueAnswer').value = clue.answer;
                document.getElementById('clueLinking').value = clue.linking_word;
                document.getElementById('clueDifficulty').value = clue.difficulty;
                document.getElementById('clueCategory').value = clue.category || '';
                document.getElementById('clueTags').value = clue.tags ? clue.tags.join(', ') : '';
                
                switchTab('builder');
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
            container.style.display = 'block';
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 5000);
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
